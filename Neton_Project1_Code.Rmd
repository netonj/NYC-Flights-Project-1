---
title: "Neton_Project1_Code"
author: "Jack Neton"
date: "2025-10-28"
output: html_document
---

```{r echo = FALSE}
# Course: Applied Statistical Inference & Experimental Design
# Purpose: A study of departure delays to improve both efficiency and customer satisfaction.
# Date: October 27, 2025
# Author: Jack Neton
```

# Load Packages

```{r message = FALSE}
# The tidyverse package contains ggplot2, dplyr, and several other packages we will use
library(tidyverse)

# The gridExtra package contains grid.arrange function used to combine plots in the same window
library(gridExtra)

# The janitor package contains tidyverse functions for cross-tables
library(janitor)

# The knitr package contains some table formating functions
library(knitr)

# The colorspace package contains color pallates for graph design
library(colorspace)

# The ggthemes package contains themes for graph design
library(ggthemes)

# The dpylr package helps with verbs for data manipulation
library(dplyr)
```

# Load Data

```{r}
# The nycflights13 package contains the data sets, compared to reading in a csv or excel file.
library(nycflights13)
```

## Join Data

```{r}
ua_flights <- flights %>%  #filter data to only contain United flights
  filter(carrier == "UA")

flights_joined <- ua_flights %>%
  inner_join(weather, by = c("year", "month", "day", "hour", "origin")) %>%  # use an inner join to combine flights and weather data
  filter(!is.na(dep_delay)) %>%  # remove NAs in departure delays
  mutate("late"= ifelse(dep_delay>0,TRUE,FALSE),"very_late"=ifelse(dep_delay>30,TRUE,FALSE)) %>% 
  filter(!is.na(precip)) %>%  # remove NAs in precipitation
  filter(!is.na(visib)) %>%  # remove NAs in visibility
  rename(departure_delay = dep_delay, precipitation = precip, visibility = visib)

flights_joined
```

Comments
We have a clean data set filtered only for UA flights and no NA values for the variables of interest. We also renamed the variables of interest for analysis, and created a late and very late variable for statistical analysis.

```{r}
flights_joined <- flights_joined[, c("departure_delay", "precipitation", "visibility", "late", "very_late")] # drop all variables except those of interest
glimpse(flights_joined)
```

Comments
We have a data set that only has the variables of interest

```{r}
str(flights_joined$departure_delay)
unique(flights_joined$departure_delay)
```

```{r}
str(flights_joined$precipitation)
unique(flights_joined$precipitation)
```

```{r}
str(flights_joined$visibility)
unique(flights_joined$visibility)
```


```{r}
flights_joined <- flights_joined %>% 
    filter(!is.na(late)) %>%  # remove NAs in precipitation
    filter(!is.na(very_late))

glimpse(flights_joined)
```


Comments
 - All data are numerical
 
```{r}
write.csv(flights_joined, "flights_joined.csv", row.names = FALSE) # export a clean csv of what has been produced
```


# Graphical EDA

## Departure Delay | Graphical

```{r}
qqnorm(flights_joined$departure_delay) # plot normal distribution
qqline(flights_joined$departure_delay) # plot distribution line
```

Comments
 - Data is very right/positively skewed
 - Light rainfall is common and consistent

```{r}
# histogram
ggplot(data = flights_joined, aes(x= departure_delay ))+
  geom_bar(bins = 60, fill = "royalblue4") + # adjust bin width and align with brand colors (royalblue4 will be used throughout)
  labs(x = "Departure Delay in minutes", title = "Distribution of Departure Delay")
```

Comments
 - Data is very right/positively skewed
 
## Precipitation | Graphical

```{r}
qqnorm(flights_joined$precipitation)
qqline(flights_joined$precipitation)
```

Comments:
 - Precipitation does not follow a normal distribution; will want to adjust how this variable is examined graphically.
 - Light rainfall is common and consistent

```{r}
ggplot(flights_joined, aes(x = precipitation)) +
  geom_histogram(bins = 40, fill = "royalblue4", color = "white") +
  labs(title = "Distribution of Precipitation", x = "Precipitation", y = "Count")
```

Comments
 - Hard to gauge full distribution from this plot. Clustered around 0. 

```{r}
# histogram

ggplot(flights_joined, aes(x = precipitation)) +
  geom_histogram(bins = 40, fill = "royalblue4", color = "white") +
    scale_x_log10() + # apply logarithmic scale for adjustment 
  labs(title = "Distribution of Precipitation", x = "Precipitation", y = "Count")

```

Comments
- Confirms right/positive skew

```{r}
ggplot(flights_joined, aes(x = precipitation)) +
  geom_boxplot(fill = "skyblue")+ #lighter shade due to area of box
    scale_x_log10() +
  labs(title = "Boxplot of Precipitation", x = "Precipitation", y = "Count")
```

Comments
- Median indicates that half of all precipitation values are very light


## Relationship of precipitation and departure delay | Graphical

```{r}
ggplot(flights_joined, aes(x = precipitation, y = departure_delay)) +
  geom_point(alpha = 0.3, color = "royalblue4") + # set point density and align with brand color
  geom_smooth(method = "lm", color = "red") + # add trend line
  labs(title = "Departure Delay vs Precipitation", x = "Precipitation", y = "Departure Delay (min)")
```

Comments
- Shows positive trend such that, as precipitation increases, so does departure delay.

```{r}
ggplot(flights_joined, aes(x = precipitation, y = departure_delay)) +
  geom_point(alpha = 0.3, color = "royalblue4") +
  geom_smooth(method = "lm", color = "red") +
  scale_x_log10() + # add logarithmic scale
  labs(title = "Departure Delay vs Precipitation", x = "Precipitation (log)", y = "Departure Delay (min)")
```


Comments
- Confirms positive trend such that, as precipitation increases, so does departure delay.

## Visibility

Visibility in this dataset is reported as integer values between 1 and 10 miles, implying the data are discrete, rather than continuous.

```{r}
qqnorm(flights_joined$visibility)
qqline(flights_joined$visibility)
```

Comments 
 - Visibility behaves like a discrete variable, with non-normal distribution. This affects my graphs below.

```{r}
ggplot(flights_joined, aes(x = visibility)) +
  geom_histogram(fill = "royalblue4") +
  labs(title = "Distribution of Visibility", x = "Visibility", y = "Count")
```

Comments
- Numbers appear to be whole, except for a few at the low end of the distribution.

```{r}
ggplot(flights_joined, aes(x = visibility)) +
  geom_density(fill = "royalblue4", alpha = 0.6) +
  labs(title = "Density of Visibility", x = "Visibility", y = "Count")
```

Comments
 - High density of observations with visibility of 10


```{r}
ggplot(flights_joined, aes(x = visibility)) +
  geom_boxplot(fill = "skyblue")+
  labs(title = "Boxplot of Visibility", x = "Visibility", y = "Count")
```

Comments
 - 10 hogs most of the distribution

## Relationship of visibility and departure delay | Graphical

```{r}
ggplot(flights_joined, aes(x = visibility, y = departure_delay)) +
  geom_point(alpha = 0.3, color = "royalblue4") +
  geom_smooth(method = "lm", color = "red") +
  labs(title = "Departure Delay vs Visibility", x = "Visibility", y = "Departure Delay (min)")
```

Comments
- Intuitively, visibiltiy increases, departure delay decreases.


## Check counts of each variable

We are seeing high density of outliers in each variable

```{r}
flights_joined %>% 
  count(precipitation, sort = TRUE)
```

Comments
 - Over 53,000 of the 57,000 observations have a 0 value
 - We may want to remove these to tighten our analysis

```{r}
flights_joined %>% 
  count(visibility, sort = TRUE)
```


Comments
 - Nearly 22,000 of the 27,000 observations have 10 as visibility
 - We may want to remove these to tighten our analysis
 
```{r}
flights_joined_reduced <- flights_joined %>% 
  filter(precipitation != 0, visibility !=10) # drop the extreme values

summary(flights_joined_reduced$precipitation)
summary(flights_joined_reduced$visibility)
```

Comments
- Dropping the extreme values worked

## Run graphs again without outliers

### Histograms without outliers

```{r}
# use grid arrange to plot two graphs in same output
grid.arrange(
  
  ggplot(flights_joined_reduced, aes(x = precipitation)) +
  geom_histogram(bins = 40, fill = "royalblue4", color = "white") +
  labs(title = "Distribution of Precipitation", x = "Precipitation", y = "Count"),
  
  ggplot(flights_joined_reduced, aes(x = visibility)) +
  geom_histogram(bins = 40, fill = "royalblue4", color = "white") +
  labs(title = "Distribution of Visibility", x = "Visibility", y = "Count"),
  
ncol = 1
)
```

Comments:
- Precipitation is still right skewed, confirming that little to light rainfall is still common
- visibility almost looks more normal, but not quite
    - still not nearly as right skewed as when observations with value of 10 were included

## Boxplots

```{r}
grid.arrange(
  
  ggplot(flights_joined_reduced, aes(x = precipitation)) +
  geom_boxplot(fill = "royalblue4") +
  labs(title = "Distribution of Precipitation", x = "Precipitation", y = "Count"),
  
  ggplot(flights_joined_reduced, aes(x = visibility)) +
  geom_boxplot(fill = "royalblue4") +
  labs(title = "Distribution of Visibility", x = "Visibility", y = "Count"),
  
ncol = 1
)
```

Comments:
 - Can see distributions much more clearly now
 - Precipitation still appears to be clustered around little to light rain
 - Visibilit becomes more even, with median right about halfway through new distribution (0-9)

### Comparison charts

```{r}
qqnorm(flights_joined_reduced$precipitation)
qqline(flights_joined_reduced$precipitation)
```

```{r}
qqnorm(flights_joined_reduced$visibility)
qqline(flights_joined_reduced$visibility)
```

Comments:
- Both plots are still poitively skewed, but, less extreme and smoother (particularly the visibility plot)

```{r}
grid.arrange(
  
  ggplot(flights_joined_reduced, aes(x = precipitation, y = departure_delay)) +
  geom_point(alpha = 0.3, color = "royalblue4") +
  geom_smooth(method = "lm", color = "red") +
  labs(title = "Departure Delay vs Precipitation", x = "Precipitation", y = "Departure Delay (min)"),
  
  ggplot(flights_joined_reduced, aes(x = visibility, y = departure_delay)) +
  geom_point(alpha = 0.3, color = "royalblue4") +
  geom_smooth(method = "lm", color = "red") +
  labs(title = "Departure Delay vs Visibility", x = "Visibility", y = "Departure Delay (min)"),
  
ncol = 1

)
```

Comments:
- Confirms positive relationship for precipitation, such that, as precipitation increases, departure delay increases.
- Contrary to what was observed earlier, as visibility increases to bound 9, departure delay increases slightly.
    - This suggests that the sheer number of observations with visibility 10 had fewer departure delays, and, skewed the trend negatively.
    
# Permutation Testing

## Precipitation

### Precipitation late

```{r}
N <- 10^4
observed <- mean(flights_joined$precipitation[flights_joined$late == TRUE]) -
             mean(flights_joined$precipitation[flights_joined$late == FALSE])

result <- numeric(N)
sample.size <- nrow(flights_joined)
group.size <- sum(flights_joined$late == TRUE)

for(i in 1:N) {
  index <- sample(sample.size, size = group.size, replace = FALSE)
  result[i] <- mean(flights_joined$precipitation[index]) -
               mean(flights_joined$precipitation[-index])
}

# Two-sided p-value
p_value <- 2 * (sum(result >= observed) + 1) / (N + 1)
p_value
```


Comments:
- p-value shows that precipitation is statistically significant for late delays.

### Precipitation very late 

```{r}
N <- 10^4
observed <- mean(flights_joined$precipitation[flights_joined$very_late == TRUE]) -
             mean(flights_joined$precipitation[flights_joined$very_late == FALSE])

result <- numeric(N)
sample.size <- nrow(flights_joined)
group.size <- sum(flights_joined$very_late == TRUE)

for(i in 1:N) {
  index <- sample(sample.size, size = group.size, replace = FALSE)
  result[i] <- mean(flights_joined$precipitation[index]) -
               mean(flights_joined$precipitation[-index])
}

# Two-sided p-value
p_value <- 2 * (sum(result >= observed) + 1) / (N + 1)
p_value
```


Comments:
- p-value shows that precipitation is statistically significant for very late delays.
- same value; no statistic significance between late and very late delays.

### Visibility late

```{r}
N <- 10^4
observed <- mean(flights_joined$visibility[flights_joined$late == TRUE]) -
             mean(flights_joined$visibility[flights_joined$late == FALSE])

result <- numeric(N)
sample.size <- nrow(flights_joined)
group.size <- sum(flights_joined$late == TRUE)

for(i in 1:N) {
  index <- sample(sample.size, size = group.size, replace = FALSE)
  result[i] <- mean(flights_joined$visibility[index]) -
               mean(flights_joined$visibility[-index])
}

# Two-sided p-value
p_upper <- (sum(result >= observed) + 1) / (N + 1)
p_lower <- (sum(result <= observed) + 1) / (N + 1)
p_value <- min(1, 2 * min(p_upper, p_lower))

p_value
```


Comments:
- p-value shows that visibility is not statistically significant for late delays.

### Visibility very late

```{r}
N <- 10^4
observed <- mean(flights_joined$visibility[flights_joined$very_late == TRUE]) -
             mean(flights_joined$visibility[flights_joined$very_late == FALSE])

result <- numeric(N)
sample.size <- nrow(flights_joined)
group.size <- sum(flights_joined$very_late == TRUE)

for(i in 1:N) {
  index <- sample(sample.size, size = group.size, replace = FALSE)
  result[i] <- mean(flights_joined$visibility[index]) -
               mean(flights_joined$visibility[-index])
}

# Two-sided p-value
p_upper <- (sum(result >= observed) + 1) / (N + 1)
p_lower <- (sum(result <= observed) + 1) / (N + 1)
p_value <- min(1, 2 * min(p_upper, p_lower))

p_value
```


Comments:
- p-value shows that visibility is statistically significant for very late delays.
- same value; no statistic significance between late and very late delays.

# Permutation testing for reduced sets

## Precipitation | Reduced

### Preciptiation late | Reduced

```{r}
N <- 10^4
observed <- mean(flights_joined_reduced$precipitation[flights_joined_reduced$late == TRUE]) -
             mean(flights_joined_reduced$precipitation[flights_joined_reduced$late == FALSE])

result <- numeric(N)
sample.size <- nrow(flights_joined_reduced)
group.size <- sum(flights_joined_reduced$late == TRUE)

for(i in 1:N) {
  index <- sample(sample.size, size = group.size, replace = FALSE)
  result[i] <- mean(flights_joined_reduced$precipitation[index]) -
               mean(flights_joined_reduced$precipitation[-index])
}

# Two-sided p-value
p_upper <- (sum(result >= observed) + 1) / (N + 1)
p_lower <- (sum(result <= observed) + 1) / (N + 1)
p_value <- min(1, 2 * min(p_upper, p_lower))

p_value
```


Comments:
- p-value shows that precipitation without 0 values is not statistically significant for late delays (i.e, when rain in present).

### Precipitation very late | Reduced

```{r}
N <- 10^4
observed <- mean(flights_joined_reduced$precipitation[flights_joined_reduced$very_late == TRUE]) -
             mean(flights_joined_reduced$precipitation[flights_joined_reduced$very_late == FALSE])

result <- numeric(N)
sample.size <- nrow(flights_joined_reduced)
group.size <- sum(flights_joined_reduced$very_late == TRUE)

for(i in 1:N) {
  index <- sample(sample.size, size = group.size, replace = FALSE)
  result[i] <- mean(flights_joined_reduced$precipitation[index]) -
               mean(flights_joined_reduced$precipitation[-index])
}

# Two-sided p-value
p_upper <- (sum(result >= observed) + 1) / (N + 1)
p_lower <- (sum(result <= observed) + 1) / (N + 1)
p_value <- min(1, 2 * min(p_upper, p_lower))

p_value
```


Comments:
- p-value shows that precipitation without 0 values is statistically significant for late delays (i.e, when rain is present, there is more siginificance for very late delays).

## Visibility | Reduced

### Visibility late | Reduced

```{r}
N <- 10^4
observed <- mean(flights_joined_reduced$visibility[flights_joined_reduced$late == TRUE]) -
             mean(flights_joined_reduced$visibility[flights_joined_reduced$late == FALSE])

result <- numeric(N)
sample.size <- nrow(flights_joined_reduced)
group.size <- sum(flights_joined_reduced$late == TRUE)

for(i in 1:N) {
  index <- sample(sample.size, size = group.size, replace = FALSE)
  result[i] <- mean(flights_joined_reduced$visibility[index]) -
               mean(flights_joined_reduced$visibility[-index])
}

# Two-sided p-value
p_upper <- (sum(result >= observed) + 1) / (N + 1)
p_lower <- (sum(result <= observed) + 1) / (N + 1)
p_value <- min(1, 2 * min(p_upper, p_lower))

p_value
```


Comments:
- p-value shows that visibility without values of 10 is statistically significant for late delays.

### Visibility very late | Reduced

```{r}
N <- 10^4
observed <- mean(flights_joined_reduced$visibility[flights_joined_reduced$very_late == TRUE]) -
             mean(flights_joined_reduced$visibility[flights_joined_reduced$very_late == FALSE])

result <- numeric(N)
sample.size <- nrow(flights_joined_reduced)
group.size <- sum(flights_joined_reduced$very_late == TRUE)

for(i in 1:N) {
  index <- sample(sample.size, size = group.size, replace = FALSE)
  result[i] <- mean(flights_joined_reduced$visibility[index]) -
               mean(flights_joined_reduced$visibility[-index])
}

# Two-sided p-value
p_upper <- (sum(result >= observed) + 1) / (N + 1)
p_lower <- (sum(result <= observed) + 1) / (N + 1)
p_value <- min(1, 2 * min(p_upper, p_lower))

p_value
```

Comments:
- Contrary to the patterns below, the p-value shows that visibility without values of 10 is not very statistically significant for very late delays.

# Is there a relationship between departure delays and whether or not there is precipitation?

### Make precipitation binary

```{r}
str(flights_joined)

```

```{r}
flights_joined <- as.data.frame(flights_joined)
```


```{r}
flights_joined <- flights_joined %>%
  mutate("rain"= ifelse(precipitation>0,TRUE,FALSE),"no_rain"=ifelse(precipitation<=0,TRUE,FALSE)) %>% 
  filter(!is.na(rain)) %>% 
  filter(!is.na(no_rain)) %>% 
  filter(!is.na(departure_delay))

glimpse(flights_joined)
```

```{r}
sum(is.na(flights_joined$departure_delay))
```

```{r}
sum(is.na(flights_joined$rain))

```

```{r}
sum(is.na(flights_joined$no_rain))

```

### EDA: Rain or not & departure delays

```{r}
ggplot(flights_joined, aes(x = departure_delay, y = rain)) +
       geom_boxplot(fill = "skyblue") +
      labs(title = "Departure Delay Distribution by Presence of Rainfall",
           x = "Departure Delay",
           y = "Rainfall Present?")
```

Comments:
- The median departure delay is higher when rain is present.
- Both delays are highly right skewed; most delays are short. I

```{r}
N <- 10^4
observed <- mean(flights_joined$departure_delay[flights_joined$rain == TRUE]) -
             mean(flights_joined$departure_delay[flights_joined$rain == FALSE])

result <- numeric(N)
sample.size <- nrow(flights_joined)
group.size <- sum(flights_joined$rain == TRUE)

for(i in 1:N) {
  index <- sample(sample.size, size = group.size, replace = FALSE)
  result[i] <- mean(flights_joined$departure_delay[index]) -
               mean(flights_joined$departure_delay[-index])
}

# Two-sided p-value
p_upper <- (sum(result >= observed) + 1) / (N + 1)
p_lower <- (sum(result <= observed) + 1) / (N + 1)
p_value <- min(1, 2 * min(p_upper, p_lower))

p_value
```

```{r}
N <- 10^4
observed <- mean(flights_joined$departure_delay[flights_joined$no_rain == TRUE]) -
             mean(flights_joined$departure_delay[flights_joined$no_rain == FALSE])

result <- numeric(N)
sample.size <- nrow(flights_joined)
group.size <- sum(flights_joined$no_rain == TRUE)

for(i in 1:N) {
  index <- sample(sample.size, size = group.size, replace = FALSE)
  result[i] <- mean(flights_joined$departure_delay[index]) -
               mean(flights_joined$departure_delay[-index])
}

# Two-sided p-value
p_upper <- (sum(result >= observed) + 1) / (N + 1)
p_lower <- (sum(result <= observed) + 1) / (N + 1)
p_value <- min(1, 2 * min(p_upper, p_lower))

p_value
```

Comments:
- We observe the same p-value for the binary rain/no-rain tests as we saw in the continuous precipitation tests
    - Thus, rain strongly increases departure delays